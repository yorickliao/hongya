<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>弘爺早餐安南長安店 線上點餐</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="light">
  <style>
    :root{
      /* 兩組主題色：可自行改色 */
      --brand:#0f172a;
      --card:#ffffff;
      --muted:#64748b;
      --ring:#e2e8f0;
      --cat-a:#242d47; /* 類別 A 標題色（鍋燒、喝湯、呷甜…） */
      --cat-b:#c9141a; /* 類別 B 標題色（呷飽飽、喝茶…） */
      --sold-badge:#e2e8f0;
    }
    .container-slim{max-width:1200px}
    .card{border-radius:1rem;background:var(--card);box-shadow:0 6px 20px rgba(2,8,23,.05);transition:transform .15s ease, box-shadow .15s ease}
    .card:hover{transform:translateY(-1px);box-shadow:0 10px 28px rgba(2,8,23,.08)}
    .btn{border-radius:1rem}
    .badge{border-radius:999px}
    .mono{font-variant-numeric:tabular-nums}
    input,select,textarea,option,button{color-scheme:light}
    input,select,textarea{
      background:#fff!important;color:#0f172a!important;-webkit-text-fill-color:#0f172a;border-color:#cbd5e1
    }
    select option{background:#fff;color:#0f172a}
    .scroll-y{overflow-y:auto;-webkit-overflow-scrolling:touch}
    .hidden-imp{display:none!important}

    /* 類別區塊標題：左側色條 + 圖示 + 標題 */
    .cat-header{display:flex;align-items:center;gap:.75rem}
    .cat-swatch{width:.4rem;height:1.5rem;border-radius:.25rem}
    .cat-a .cat-swatch{background:var(--cat-a)}
    .cat-b .cat-swatch{background:var(--cat-b)}
    .cat-a h2{color:var(--cat-a)}
    .cat-b h2{color:var(--cat-b)}
    .cat-wrap{display:flex;flex-direction:column;gap:.75rem}

    /* 商品卡片內的價錢與售完徽章區 */
    .item-price{font-weight:700}
    .sold-badge{background:var(--sold-badge);color:#475569}

    /* 選擇按鈕禁用態（售完） */
    .choose-btn[aria-disabled="true"]{opacity:.5;pointer-events:none}

    /* 成功視窗卡片 */
    #successModal .card{box-shadow:0 16px 40px rgba(15,23,42,.2)}

    /* 分類錨點區塊：讓捲動後卡在固定導覽下方剛好顯示 */
    .section-anchor{ scroll-margin-top: 128px; } /* 視實際 header/分類列高度可微調 */
    
    /* 隱藏水平卷軸（仍可左右滑） */
    .no-scrollbar::-webkit-scrollbar{ display:none; }
    .no-scrollbar{ -ms-overflow-style:none; scrollbar-width:none; }
    
    /* 分類按鈕選中狀態 */
    .catbtn.is-active{
      background:#0f172a;     /* slate-900 */
      color:#fff !important;  /* 被選中時反白 */
      border-color:#0f172a;
    }
  </style>
</head>

<body class="bg-slate-50 text-slate-900 selection:bg-slate-200 selection:text-slate-900">
<header class="sticky top-0 z-30 bg-white/80 backdrop-blur border-b border-slate-200">
  <div class="mx-auto container-slim px-4 py-4 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 bg-slate-900 text-white rounded-xl grid place-items-center text-lg font-bold select-none">招</div>
      <div>
        <div class="text-xl font-semibold">弘爺早餐安南長安店 線上點餐</div>
        <div class="text-xs text-slate-500">營業時間: 每日 05:30 - 13:00</div>
        <div class="text-xs text-slate-500">台南市安南區長和路二段12巷277弄6號 06-3561258</div>
      </div>
    </div>
    <a href="#cart" class="btn px-3 py-2 border border-slate-300 hover:bg-slate-100">購物車</a>
  </div>
</header>

<!-- 分類快速選擇列 -->
<nav id="categoryBar" class="sticky z-40 bg-white/90 backdrop-blur border-b border-slate-200">
  <div class="mx-auto container-slim px-4 py-2">
    <div class="flex gap-2 overflow-x-auto no-scrollbar">
      <button class="catbtn px-3 py-1.5 rounded-xl border border-slate-300 bg-white shrink-0" data-cat="setmeal" style="color:#242d47">套餐</button>
      <button class="catbtn px-3 py-1.5 rounded-xl border border-slate-300 bg-white shrink-0" data-cat="burger"  style="color:#c9141a">漢堡</button>
      <button class="catbtn px-3 py-1.5 rounded-xl border border-slate-300 bg-white shrink-0" data-cat="toast"   style="color:#242d47">烤土司</button>
      <button class="catbtn px-3 py-1.5 rounded-xl border border-slate-300 bg-white shrink-0" data-cat="omelet"  style="color:#c9141a">蛋餅</button>
      <button class="catbtn px-3 py-1.5 rounded-xl border border-slate-300 bg-white shrink-0" data-cat="club"    style="color:#242d47">總匯</button>
      <button class="catbtn px-3 py-1.5 rounded-xl border border-slate-300 bg-white shrink-0" data-cat="special" style="color:#c9141a">店長推薦</button>
      <button class="catbtn px-3 py-1.5 rounded-xl border border-slate-300 bg-white shrink-0" data-cat="custom"  style="color:#242d47">帕瑪森/捲餅/香頌/燒餅</button>
      <button class="catbtn px-3 py-1.5 rounded-xl border border-slate-300 bg-white shrink-0" data-cat="snacks"  style="color:#c9141a">美味小點</button>
      <button class="catbtn px-3 py-1.5 rounded-xl border border-slate-300 bg-white shrink-0" data-cat="hotpot"  style="color:#242d47">鍋燒系列</button>
      <button class="catbtn px-3 py-1.5 rounded-xl border border-slate-300 bg-white shrink-0" data-cat="drinks"  style="color:#c9141a">飲料</button>
      <button class="catbtn px-3 py-1.5 rounded-xl border border-slate-300 bg-white shrink-0" data-cat="coffee"  style="color:#242d47">研磨咖啡</button>
      
    </div>
  </div>
</nav>

<main class="mx-auto container-slim px-4 py-8 grid grid-cols-1 lg:grid-cols-3 gap-8">
  <section class="lg:col-span-2 space-y-10">
    <!-- 套餐（A 色） -->
    <div class="cat-wrap cat-a">
      <div class="cat-header">
        <span class="cat-swatch"></span>
        <h2 class="text-lg font-semibold flex items-center gap-2">套餐 (均附小杯紅茶，可折抵其他飲品或濃湯）</h2>
      </div>
      <div id="setmealList" class="grid grid-cols-2 gap-4"></div>
    </div>
  
    <!-- 漢堡（B 色） -->
    <div class="cat-wrap cat-b">
      <div class="cat-header">
        <span class="cat-swatch"></span>
        <h2 class="text-lg font-semibold">漢堡</h2>
      </div>
      <div id="burgerList" class="grid grid-cols-2 gap-4"></div>
    </div>
  
    <!-- 烤土司（A 色） -->
    <div class="cat-wrap cat-a">
      <div class="cat-header">
        <span class="cat-swatch"></span>
        <h2 class="text-lg font-semibold">烤土司</h2>
      </div>
      <div id="toastList" class="grid grid-cols-2 gap-4"></div>
    </div>
  
    <!-- 蛋餅（B 色） -->
    <div class="cat-wrap cat-b">
      <div class="cat-header">
        <span class="cat-swatch"></span>
        <h2 class="text-lg font-semibold">蛋餅</h2>
      </div>
      <div id="omeletList" class="grid grid-cols-2 gap-4"></div>
    </div>
  
    <!-- 總匯（A 色） -->
    <div class="cat-wrap cat-a">
      <div class="cat-header">
        <span class="cat-swatch"></span>
        <h2 class="text-lg font-semibold">總匯</h2>
      </div>
      <div id="clubList" class="grid grid-cols-2 gap-4"></div>
    </div>
  
    <!-- 店長推薦（B 色） -->
    <div class="cat-wrap cat-b">
      <div class="cat-header">
        <span class="cat-swatch"></span>
        <h2 class="text-lg font-semibold">店長推薦</h2>
      </div>
      <div id="specialList" class="grid grid-cols-2 gap-4"></div>
    </div>

    <!-- 帕瑪森/捲餅/香頌/燒餅（A 色） -->
    <div class="cat-wrap cat-a">
      <div class="cat-header">
        <span class="cat-swatch"></span>
        <h2 class="text-lg font-semibold">帕瑪森/捲餅/香頌/燒餅</h2>
      </div>
      <div id="customList" class="grid grid-cols-2 gap-4"></div>
    </div>

    <!-- 美味小點（B 色） -->
    <div class="cat-wrap cat-b">
      <div class="cat-header">
        <span class="cat-swatch"></span>
        <h2 class="text-lg font-semibold">美味小點</h2>
      </div>
      <div id="snacksList" class="grid grid-cols-2 gap-4"></div>
    </div>

    <!-- 鍋燒系列（A 色） -->
    <div class="cat-wrap cat-a">
      <div class="cat-header">
        <span class="cat-swatch"></span>
        <h2 class="text-lg font-semibold">鍋燒系列</h2>
      </div>
      <div id="hotpotList" class="grid grid-cols-2 gap-4"></div>
    </div>
  
    <!-- 飲料/研磨咖啡（A/B 色） -->
    <div class="cat-wrap cat-b">
      <div class="cat-header">
        <span class="cat-swatch"></span>
        <h2 class="text-lg font-semibold">飲料</h2>
      </div>
      <div id="drinksList" class="grid grid-cols-2 gap-4"></div>
    </div>

    <div class="cat-wrap cat-a">
      <div class="cat-header">
        <span class="cat-swatch"></span>
        <h2 class="text-lg font-semibold">研磨咖啡</h2>
      </div>
      <div id="coffeeList" class="grid grid-cols-2 gap-4"></div>
    </div>
  </section>

  <aside id="cart"
    class="space-y-6 lg:sticky lg:top-[88px] lg:max-h-[calc(100vh-120px)] lg:overflow-y-auto lg:pr-1"
    style="-webkit-overflow-scrolling: touch;">
    <div class="card bg-white p-5">
      <h2 class="text-lg font-semibold mb-4">購物車</h2>
      <div id="cartItems" class="space-y-3"></div>
      <div class="border-t pt-4 mt-4 flex items-center justify-between text-lg font-semibold">
        <div>總計</div>
        <div id="cartTotal" class="mono">$0</div>
      </div>
      <button id="clearCart" class="mt-3 w-full btn px-4 py-2 border border-slate-300 hover:bg-slate-100">清空購物車</button>
    </div>

    <div class="card bg-white p-5">
      <h2 class="text-lg font-semibold mb-4">取餐資訊</h2>
      <form id="checkoutForm" class="space-y-4" autocomplete="off">
        <!-- 用餐方式 -->
        <div>
          <label class="text-sm text-slate-600">用餐方式</label>
          <div class="mt-2 grid grid-cols-2 gap-2">
            <label class="flex items-center gap-2 border rounded-xl px-3 py-2 cursor-pointer">
              <input type="radio" name="diningType" value="takeout" checked>
              <span>外帶</span>
            </label>
            <label class="flex items-center gap-2 border rounded-xl px-3 py-2 cursor-pointer">
              <input type="radio" name="diningType" value="dinein">
              <span>內用</span>
            </label>
          </div>
        </div>

        <!-- 外帶：取餐時間 -->
        <div id="takeoutBlock">
          <label class="text-sm text-slate-600">取餐時間（未選則自動安排最早可取時段）</label>
          <select id="pickupSelect"
                  class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 bg-white text-slate-900">
          </select>
          <p id="pickupHint" class="text-xs text-slate-500 mt-1">營業時段：05:30–13:00；每 15 分鐘一個時段。</p>
          <p id="offHourMsg" class="text-sm text-amber-700 mt-2 hidden-imp"></p>
        </div>

        <!-- 內用：桌號 -->
        <div id="dineinBlock" class="hidden">
          <label class="text-sm text-slate-600">桌號</label>
          <input id="tableNo" type="text" placeholder=""
                 class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 bg-white text-slate-900" />
        </div>

        <!-- 姓名/電話 -->
        <div>
          <label class="text-sm text-slate-600">姓名</label>
          <input required id="customerName" type="text"
                 class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 bg-white text-slate-900" />
        </div>
        <div>
          <label class="text-sm text-slate-600">電話</label>
          <input required id="customerPhone" type="tel" pattern="[0-9\-+\s]{8,}" placeholder="09xx-xxx-xxx"
                 class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 bg-white text-slate-900" />
        </div>

        <button id="submitBtn" type="submit" class="w-full btn px-4 py-3 bg-slate-900 text-white hover:bg-slate-800">送出訂單</button>
        <p id="formError" class="text-sm text-red-600"></p>
      </form>
    </div>
  </aside>
</main>

<!-- 成功視窗：依用餐方式條件顯示 -->
<div id="successModal" class="fixed inset-0 z-40 hidden">
  <div class="absolute inset-0 bg-black/40"></div>
  <div class="relative z-10 mx-auto mt-24 w-[92%] max-w-xl card bg-white p-6">
    <h3 class="text-xl font-semibold mb-4">下單成功</h3>

    <div class="space-y-2">
      <p class="text-slate-700">取餐編號</p>
      <p id="pickupNoText" class="text-4xl font-extrabold tracking-wider mt-1 mono"></p>
    </div>

    <!-- 外帶才顯示 -->
    <div id="successTakeoutTime" class="space-y-2 mt-4 hidden">
      <p class="text-slate-700">取餐時間</p>
      <p id="pickupTimeText" class="text-2xl font-bold mt-1 mono"></p>
    </div>

    <!-- 內用才顯示 -->
    <div id="successTable" class="space-y-2 mt-4 hidden">
      <p class="text-slate-700">桌號</p>
      <p id="tableNoText" class="text-2xl font-bold mt-1 mono"></p>
    </div>

    <div class="mt-6 flex justify-end">
      <button id="closeSuccess" class="btn px-4 py-2 border border-slate-300 hover:bg-slate-100">關閉</button>
    </div>
  </div>
</div>

<footer class="border-t border-slate-200 mt-12">
  <div class="mx-auto container-slim px-4 py-6 text-sm text-slate-600">
    <div class="flex flex-wrap items-center justify-between gap-3">
      <div>© <span id="year"></span> 弘爺安南長安店</div>
    </div>
  </div>
</footer>

<script>
/* === 設定（請替換為你的 GAS 部署網址 / API Key）=== */
const ENDPOINT = 'https://script.google.com/macros/s/AKfycbzu0DMtEudF75HqZzgS81r2CbLZRghGGJoSbRVK3e507YJIAMd6lSa1ZxvsPhB2nr4d/exec';
const API_KEY  = 'hongya';

/* === 工具 & 狀態 === */
const el = s => document.querySelector(s);
const money = n => '$' + Number(n||0).toLocaleString('zh-Hant');
const pad2 = n => String(n).padStart(2, '0');
const state = { cart: [], slots: [] };

/* 新增：API 錯誤訊息對應（paused → 目前商家停止接單） */
function mapApiError(errCode, serverMessage){
  const code = String(errCode || '').toLowerCase();
  if (code === 'paused') return '目前商家停止接單';
  return serverMessage || '送單失敗，請稍後再試';
}

/* === 參數：營業時間（早餐店） === */
const BUSINESS = { startHour:5, endHour:13, intervalMin:15 };

/* === 分類規則（一般類：漢堡/吐司/蛋餅/總匯/客製） === */
const CATEGORY_OPTION_RULES = {
  setmeal: [],   // 套餐：走專屬 UI（見 buildSetmealControls）
  special: [],
  snacks: [],

  burger: [
    { type:'toggle', key:'egg',    label:'加蛋',   price:15 },
    { type:'toggle', key:'cheese', label:'加起司', price:10 },
    { type:'choice', key:'bread',  label:'麵包',   options:[
      { label:'漢堡', value:'漢堡', price:0 },
      { label:'圓形帕瑪森',       value:'圓形帕瑪森', price:10 },
    ]},
  ],

  toast: [
    { type:'toggle', key:'cheese', label:'加起司', price:15 },
    { type:'choice', key:'base',   label:'主體',   options:[
      { label:'吐司', value:'吐司', price:0 },
      { label:'鬆餅',         value:'鬆餅', price:15 },
    ]},
  ],

  omelet: [
    { type:'toggle', key:'cheese', label:'加起司', price:10 },
  ],

  club: [
    { type:'toggle', key:'cheese', label:'加起司', price:10 },
  ],

  custom: [
    { type:'choice', key:'bread', label:'麵包體', options:[
      { label:'帕瑪森', value:'帕瑪森', price:0 },
      { label:'捲餅',   value:'捲餅',   price:0 },
      { label:'香頌',   value:'香頌',   price:0 },
      { label:'燒餅',   value:'燒餅',   price:0 },
    ]},
    { type:'toggle', key:'egg',    label:'加蛋',   price:15 },
    { type:'toggle', key:'cheese', label:'加起司', price:10 },
  ],
  hotpot: [
    { type:'toggle', key:'cheese', label:'加起司', price:10 },
    { type:'toggle', key:'shacha', label:'加沙茶', price:10 },
    { type:'toggle', key:'extra_noodle', label:'加麵', price:15 },
  ],
  // drinks / coffee 都走專屬 UI（見 buildDrinkControls / buildCoffeeControls）
  drinks: [],
  coffee: []
};

/* === 菜單 === */
const MENU = {
  setmeal: [
    { id:"set_placeholder",            name:"美式奔牛堡套餐",     price:140 },
    { id:"set_chicken_tender",         name:"起飛嫩雞堡套餐",   price:120 },
    { id:"set_double_pork_cheese",     name:"雙層豬肉起司堡套餐", price:105 },
    { id:"set_german_parmesan",        name:"德式帕瑪森套餐",   price:120 },
    { id:"set_euro_mash_salad",        name:"歐式薯泥沙拉套餐", price:105 },
    { id:"set_french_mash_salad",      name:"法式薯泥沙拉套餐", price:105 },
    { id:"set_lemon_chicken_noodle",   name:"檸檬雞柳麵套餐",   price:110 },
    { id:"set_stirfry_pork_noodle",    name:"蔥爆燒肉炒麵套餐", price:95  },
    { id:"set_loin_iron_noodle",       name:"里肌鐵板麵套餐",   price:95 },
    { id:"set_signature_club",         name:"招牌總匯套餐",     price:100 },
    { id:"set_greenonion_gina",        name:"香蔥吉拿套餐",   price:90 },
    { id:"set_kids_meal",              name:"歡樂兒童餐",       price:90  },
    { id:"set_fried_chicken",          name:"美式脆雞堡套餐",   price:130 },
    { id:"set_green_curry",            name:"沙嗲咖哩麵套餐",   price:125  },
    { id:"set_american_pork",          name:"美式大豬堡套餐",   price:120 },
    { id:"set_waffle",                 name:"華夫鬆餅套餐",     price:130 },
  ],

  burger: [
    { id:"burg_american_pork",            name:"美式大豬堡",        price:85 },
    { id:"burg_fillet_chicken_egg",       name:"菲力雞排蛋堡",      price:85 },
    { id:"burg_spicy_chicken_egg",        name:"卡拉雞腿蛋堡（原味）",       price:80 },
    { id:"burg_spicy_chicken_egg_spicy",  name:"卡拉雞腿蛋堡（辣味）",       price:80 },
    { id:"burg_fish_egg",                 name:"酥炸魚柳蛋堡",            price:80 },
    { id:"burg_pepper_chicken_egg",       name:"椒麻雞排蛋堡",            price:80 },
    { id:"burg_shrimp_egg",               name:"金蝦蛋堡",                price:75 },
    { id:"burg_cheese_chicken_egg",       name:"起司雞排蛋堡",            price:75 },
    { id:"burg_beef_egg",                 name:"牛肉蛋堡",                price:75 },
    { id:"burg_sauce_chicken_egg",        name:"醬燒雞腿蛋堡",            price:65 },
    { id:"burg_pork_egg",                 name:"豬柳蛋堡",                price:60 },
    { id:"burg_loin_egg",                 name:"里肌蛋堡",                price:60 },
    { id:"burg_hash_egg",                 name:"薯餅蛋堡",                price:60 },
    { id:"burg_smoked_chicken_egg",       name:"燻雞蛋堡",                price:55 },
    { id:"burg_wheat_chicken_egg",        name:"麥香雞蛋堡",              price:50 },
    { id:"burg_tuna_egg",                 name:"鮪魚蛋堡",                price:50 },
    { id:"burg_pork",                     name:"豬肉蛋堡",                price:50 },
    { id:"burg_veggie_egg",               name:"蔬菜蛋堡",                price:45 },
    { id:"burg_plain_egg",                name:"蛋堡",                    price:35 },
  ],

  toast: [
    { id:"toast_fried_pork",     name:"炸豬排三明治",   price:95 },
    { id:"toast_spicy_chicken",  name:"卡拉雞腿蛋吐司(原味)", price:80 },
    { id:"toast_spicy_chicken",  name:"卡拉雞腿蛋吐司(辣味)", price:80 },
    { id:"toast_beef_egg",       name:"牛肉蛋吐司",     price:75 },
    { id:"toast_loin_egg",       name:"厚切里肌蛋吐司", price:75 },
    { id:"toast_shrimp_egg",     name:"金蝦蛋吐司",     price:75 },
    { id:"toast_cheese_chicken", name:"起司雞排蛋吐司", price:75 },
    { id:"toast_hala_chicken",   name:"哈辣雞腿蛋吐司", price:75 },
    { id:"toast_ligi",           name:"里肌蛋吐司",     price:60 },
    { id:"toast_pig_liu",        name:"豬柳蛋吐司",     price:60 },
    { id:"toast_hash",           name:"薯餅蛋吐司",     price:60 },
    { id:"toast_egg_salad",      name:"雞蛋沙拉吐司",    price:50 },
    { id:"toast_chicken",        name:"麥香雞蛋吐司",     price:50 },
    { id:"toast_tuna_egg",       name:"鮪魚蛋吐司",     price:50 },
    { id:"toast_pork_egg",       name:"豬肉蛋吐司",     price:50 },
    { id:"toast_bacon_egg",      name:"培根蛋吐司",     price:45 },
    { id:"toast_mash_salad",     name:"薯泥沙拉吐司",   price:45 },
    { id:"toast_ham_egg",        name:"火腿蛋吐司",     price:40 },
    { id:"toast_cheese_egg",     name:"起司蛋吐司",     price:35 },
    { id:"toast_floss_egg",      name:"肉鬆蛋吐司",     price:35 },
    { id:"toast_plain_egg",      name:"吐司夾蛋",       price:30 },
    { id:"toast_jam_series",   name:"果醬吐司", price:20, tag:"jam_series" },
    { id:"toast_thick_series", name:"厚片吐司", price:30, tag:"thick_series" },
    { id:"toast_bacon_bake",     name:"培根焗烤厚片",     price:55 },
    { id:"toast_tuna_bake",      name:"鮪魚焗烤厚片",     price:55 },
    { id:"toast_ham_bake",       name:"火腿焗烤厚片",     price:55 },
  ],

  /* ★補回完整蛋餅清單 */
  omelet: [
    { id:"omelet_karla",      name:"卡拉蛋餅（原味）", price:75 },
    { id:"omelet_karla_sp",   name:"卡拉蛋餅（辣味）", price:75 },
    { id:"omelet_loin",       name:"里肌蛋餅",       price:55 },
    { id:"omelet_mash",       name:"薯泥蛋餅",       price:50 },
    { id:"omelet_hash",       name:"薯餅蛋餅",       price:50 },
    { id:"omelet_pork",       name:"豬肉蛋餅",       price:45 },
    { id:"omelet_tuna",       name:"鮪魚蛋餅",       price:45 },
    { id:"omelet_bacon",      name:"培根蛋餅",       price:45 },
    { id:"omelet_hotdog",     name:"熱狗蛋餅",       price:40 },
    { id:"omelet_ham",        name:"火腿蛋餅",       price:40 },
    { id:"omelet_corn",       name:"玉米蛋餅",       price:40 },
    { id:"omelet_cheese",     name:"起司蛋餅",       price:35 },
    { id:"omelet_veggie",     name:"鮮蔬蛋餅",       price:35 },
    { id:"omelet_pork_floss", name:"肉鬆蛋餅",       price:35 },
    { id:"omelet_plain",      name:"原味蛋餅",       price:30 },
  ],

  /* ★補回完整總匯清單 */
  club: [
    { id:"club_chicken_leg",    name:"卡拉雞腿總匯",   price:95 },
    { id:"club_tender_chicken", name:"起飛嫩雞總匯",   price:95 },
    { id:"club_shrimp",         name:"金蝦總匯",       price:85 },
    { id:"club_sauce_chicken",  name:"醬燒雞總匯",     price:80 },
    { id:"club_loin",           name:"里肌總匯",       price:75 },
    { id:"club_smoked_chicken", name:"燻雞總匯",       price:75 },
    { id:"club_signature",      name:"招牌總匯",       price:70 },
    { id:"club_tuna",           name:"鮪魚總匯",       price:70 },
  ],

  /* ★補回店長推薦 */
  special: [
    { id:"sp_egg_salad",     name:"雞蛋沙拉",   price:65 },
    { id:"sp_fries",         name:"脆薯",       price:40 },
    { id:"sp_garlic_bread",  name:"香蒜麵包",   price:35 },
    { id:"sp_nuggets",       name:"雞塊",       price:35 },
    { id:"sp_meat_beans",    name:"小肉豆",     price:35 },
  ],

  /* ★補回客製（帕瑪森系列為例） */
  custom: [
    { id:"custom_parmesan_hchicken",     name:"哈辣雞腿",   price:80 },
    { id:"custom_parmesan_sausage",      name:"德式香腸",   price:80 },
    { id:"custom_parmesan_cheesechicken",name:"起司雞排",   price:75 },
    { id:"custom_parmesan_italian",      name:"義式雞",     price:75 },
    { id:"custom_parmesan_loin",         name:"嫩煎里肌",   price:75 },
    { id:"custom_parmesan_smokedchicken",name:"香燻雞排",   price:75 },
    { id:"custom_parmesan_eggsalad",     name:"雞蛋沙拉",   price:70 },
    { id:"custom_parmesan_tuna",         name:"洋蔥鮪魚",   price:70 },
    { id:"custom_parmesan_mash",         name:"薯泥沙拉",   price:70 },
    { id:"custom_parmesan_veggie",       name:"鮮蔬沙拉",   price:60 },
  ],

  /* 美味小點（放在飲料前） */
  snacks: [
    { id:"snack_noodle_egg_mushroom",   name:"鐵板麵加蛋（蘑菇）",  price:65 },
    { id:"snack_noodle_egg_blackpepper",name:"鐵板麵加蛋（黑胡椒）",price:65 },
    { id:"snack_crispy_chicken",        name:"香脆雞",              price:45 },
    { id:"snack_scallion_pancake_egg",  name:"蔥抓餅加蛋",          price:45 },
    { id:"snack_hash_egg_tart",         name:"薯餅蛋塔",            price:45 },
    { id:"snack_corn_soup",             name:"玉米濃湯",            price:40 },
    { id:"snack_lemon_chicken_strip",   name:"檸檬雞柳條",          price:45 },
    { id:"snack_churros",               name:"香蔥吉拿棒",          price:40 },
    { id:"snack_hashbrown",             name:"薯餅",                price:40 },
    { id:"snack_hotdog_scramble",       name:"熱狗散蛋",            price:40 },
    { id:"snack_tempura",               name:"香酥甜不辣",          price:40 },
    { id:"snack_fish_strip",            name:"酥炸魚條",            price:45 },
    { id:"snack_radish_egg",            name:"蘿蔔糕散蛋",          price:55 },
    { id:"snack_radish",                name:"蘿蔔糕",              price:40 },
    { id:"snack_dumpling",              name:"煎餃",                price:40 },
    { id:"snack_fries",                 name:"薯條",                price:30 },
    { id:"snack_hotdog",                name:"熱狗",                price:25 },
    { id:"snack_fried_egg",             name:"荷包蛋",              price:15 },
  ],

    /* 鍋燒系列 */
  hotpot: [
    { id:"hotpot_noodle",  name:"鍋燒意麵", price:75 },
    { id:"hotpot_chicken", name:"鍋燒雞絲", price:75 },
    { id:"hotpot_vermicelli", name:"鍋燒冬粉", price:75 },
    { id:"hotpot_udon",    name:"鍋燒烏龍", price:80 },
  ],


  /* 飲料：中為 base；L +5、XL +10（有的只限 L/XL 或僅冰） */
  drinks: [
    { id:"drink_black_tea",       name:"紅茶",           price:15 },
    { id:"drink_milk_tea",        name:"奶茶",           price:20 },
    { id:"drink_green_tea",       name:"無糖綠茶",       price:15 },
    { id:"drink_wintermelon_tea", name:"冬瓜茶",         price:25 },
    { id:"drink_soy_milk",        name:"豆漿",           price:20 },
    { id:"drink_soy_milk_ns",     name:"無糖豆漿",        price:20 },
    { id:"drink_barley_milk",     name:"薏仁漿",         price:20 },
    { id:"drink_rice_milk",       name:"米漿",           price:20 },
    { id:"drink_orange_juice",    name:"柳橙汁",         price:30 }, // only 冰
    { id:"drink_cranberry_juice", name:"蔓越莓汁",       price:30 }, // only 冰
    { id:"drink_fresh_milk_tea",  name:"鮮奶茶",  price:35 },
    { id:"drink_barley_milk_milk",name:"薏仁牛奶",  price:35 },
    { id:"drink_soy_milk_tea",    name:"豆奶茶",    price:30 },
    { id:"drink_cocoa_milk",      name:"可可亞牛奶",price:35 },
    { id:"drink_thai_milk_tea",   name:"泰式奶茶",price:35 },
    { id:"drink_cold_brew_tea",   name:"冷泡茶",  price:25 }, // only 冰
  ],

  /* 研磨咖啡：依 PDF 價（不套 +5/+10；彈窗用固定 M/L 價） */
  coffee: [
    { id:"coffee_americano", name:"美式咖啡",   price:35 },
    { id:"coffee_latte",     name:"拿鐵咖啡",   price:50 },
    { id:"coffee_special",   name:"特調咖啡",   price:40 },
    { id:"coffee_yuanyang",  name:"鴛鴦奶茶",   price:40 },
  ],
};

/* === 飲料規則（杯型/冰熱） ===
   baseSize: 'M' | 'L'  用來決定 +5/+10 的基準
   sizes:    允許的杯型（M/L/XL）
   temps:    允許的溫度（ice/hot）
   注意：此區塊只能宣告一次，避免 const 重複造成 JS 中斷
*/
const DRINKS_META = {
  drink_black_tea:        { baseSize:'M', sizes:['M','L','XL'], temps:['ice','hot'] },
  drink_soy_milk:         { baseSize:'M', sizes:['M','L','XL'], temps:['ice','hot'], xlExtra:15 },
  drink_unsweet_soy_milk: { baseSize:'M', sizes:['M','L','XL'], temps:['ice','hot'], xlExtra:15 },
  drink_milk_tea:         { baseSize:'M', sizes:['M','L','XL'], temps:['ice','hot'], xlExtra:15 },
  drink_barley_milk:      { baseSize:'M', sizes:['M','L','XL'], temps:['ice','hot'], xlExtra:15 },
  drink_rice_milk:        { baseSize:'M', sizes:['M','L','XL'], temps:['ice','hot'], xlExtra:15 },
  drink_green_tea:       { baseSize:'M', sizes:['M','L','XL'], temps:['ice','hot']},
  drink_wintermelon_tea: { baseSize:'L', sizes:['L','XL'], temps:['ice','hot'], xlExtra:5 },

  
  drink_orange_juice:     { baseSize:'M', sizes:['M','L','XL'], temps:['ice']      }, // 只有冰
  drink_cranberry_juice:  { baseSize:'M', sizes:['M','L','XL'], temps:['ice']      }, // 只有冰
  drink_fresh_milk_tea:   { baseSize:'L', sizes:['L','XL'],     temps:['ice','hot'] },
  drink_barley_milk_milk: { baseSize:'L', sizes:['L','XL'],     temps:['ice','hot'] },
  drink_soy_milk_tea:     { baseSize:'L', sizes:['L','XL'],     temps:['ice','hot'] },
  drink_cocoa_milk:       { baseSize:'L', sizes:['L','XL'],     temps:['ice','hot'] },
  drink_thai_milk_tea:    { baseSize:'L', sizes:['L','XL'],     temps:['ice','hot'] },
  drink_cold_brew_tea:    { baseSize:'L', sizes:['L','XL'],     temps:['ice']      }, // 只有冰
};

// 用餐升級飲品（以套餐含「小杯紅茶」為基準的加價）
const SETMEAL_DRINKS = [
  { id:'drink_black_tea',        label:'紅茶',        add:0  },
  { id:'drink_milk_tea',         label:'奶茶',        add:5  },
  { id:'drink_green_tea',        label:'無糖綠茶',    add:0  },
  { id:'drink_wintermelon_tea',  label:'冬瓜茶',      add:5  },
  { id:'drink_soy_milk',         label:'豆漿',        add:5  },
  { id:'drink_soy_milk_ns',      label:'無糖豆漿',     add:5  },
  { id:'drink_barley_milk',      label:'薏仁漿',      add:5  },
  { id:'drink_rice_milk',        label:'米漿',        add:5  },
  { id:'drink_orange_juice',     label:'柳橙汁',      add:15  },  // 只供冰
  { id:'drink_cranberry_juice',  label:'蔓越莓汁',    add:15  },  // 只供冰
  { id:'drink_fresh_milk_tea',   label:'鮮奶茶',      add:20 },
  { id:'drink_barley_milk_milk', label:'薏仁牛奶',    add:20 },
  { id:'drink_soy_milk_tea',     label:'豆奶茶',    add:15 },
  { id:'drink_cocoa_milk',       label:'可可亞牛奶',  add:20 },
  { id:'drink_thai_milk_tea',    label:'泰式奶茶',    add:20 },
  { id:'drink_cold_brew_tea',    label:'冷泡茶',      add:10 },  // 只供冰
];

/* ★ 套餐「進去可以選」的附加選項（不加價，只做紀錄） */
const SETMEAL_EXTRA_RULES = {
  set_lemon_chicken_noodle: {                 // 檸檬雞柳麵套餐
    key: 'sauce', label: '醬汁',
    options: [ '紅醬', '青醬', '白醬' ]
  },
  set_stirfry_pork_noodle: {                  // 蔥爆燒肉炒麵套餐
    key: 'style', label: '口味',
    options: [ '沙茶', '蔥燒' ]
  },
  set_loin_iron_noodle: {                     // 里肌鐵板麵套餐
    key: 'sauce', label: '醬汁',
    options: [ '黑胡椒', '蘑菇' ]
  },
  set_fried_chicken: {                        // 美式脆雞堡套餐
    key: 'flavor', label: '口味',
    options: [ '原味', '辣味' ]
  }
};

/* === Render：分類卡片（帶入分類 key，讓彈窗知道走哪組規則） === */
function renderCategory(list, targetId, catKey){
  const root = el(targetId); if (!root) return;
  root.innerHTML='';
  list.forEach(item=>{
    const itemWithCat = { ...item, _catKey: catKey };
    const card = document.createElement('div');
    card.className = 'card bg-white p-4 flex flex-col';
    card.innerHTML = `
      <div class="flex items-start justify-between gap-3">
        <div class="min-w-0">
          <h3 class="text-base lg:text-lg font-semibold truncate">${item.name}</h3>
        </div>
        <div class="text-right item-price mono">${money(item.price)}</div>
      </div>
      <div class="mt-4 flex justify-end">
        <button class="choose-btn btn px-4 py-2 bg-slate-900 text-white hover:bg-slate-800" data-name="${item.name}">
          選擇
        </button>
      </div>`;
    card.querySelector('.choose-btn').addEventListener('click', ()=> openItemModal(itemWithCat));
    root.appendChild(card);
  });
}

/* === 選項彈窗 === */
let currentItem = null;
function openItemModal(item){
  checkSoldOutByName(item.name).then(sold=>{
    if (sold) { alert('此品項已售完'); enforceSoldOutOnMenu(true); return; }

    currentItem = item;
    ensureItemModal();
    document.body.classList.add('overflow-hidden');

    el('#pmTitle').textContent = item.name;

    // 早餐不需要主食；保留相容
    const stapleWrap = el('#pmStapleWrap');
    const needStaple = !!item.requireStaple;
    stapleWrap.style.display = needStaple ? '' : 'none';

    // 依分類生成 UI
    if (item._catKey === 'drinks') {
      buildDrinkControls(item);
    } else if (item._catKey === 'coffee') {
      buildCoffeeControls(item);
    } else if (item._catKey === 'setmeal') {
      buildSetmealControls(item);
    } else if (item._catKey === 'toast' && item.tag === 'jam_series') {
      buildToastSeriesControls('jam');
    } else if (item._catKey === 'toast' && item.tag === 'thick_series') {
      buildToastSeriesControls('thick');// 果醬吐司選口味
    } else {
      buildOptionControls(item._catKey); // 一般類
    }

    // 備註 & 數量
    el('#pmRemark').value = '';
    const qtyInput = el('#pmQty'); qtyInput.value = 1;

    const updatePmSubtotal = ()=>{
      const qty = Math.max(1, parseInt(qtyInput.value)||1);
      const unit = calcUnitPrice(item);
      el('#pmSubtotal').textContent = money(unit * qty);
    };
    el('#pmDec').onclick = ()=>{ qtyInput.value = Math.max(1, (parseInt(qtyInput.value)||1) - 1); updatePmSubtotal(); };
    el('#pmInc').onclick = ()=>{ qtyInput.value = (parseInt(qtyInput.value)||1) + 1; updatePmSubtotal(); };
    qtyInput.oninput = updatePmSubtotal;
    const pmOptions = el('#pmOptions');
    // 用委派，避免動態新增的杯型/冰熱選單沒被監聽
    pmOptions.onchange = updatePmSubtotal;

    updatePmSubtotal();

    el('#pmAdd').onclick = async ()=>{
      const sold = await checkSoldOutByName(item.name);
      if (sold) { alert('此品項已售完'); enforceSoldOutOnMenu(true); return; }

      const qty    = Math.max(1, parseInt(qtyInput.value)||1);
      const remark = (el('#pmRemark')?.value || '').trim();

      // 讀取選項 → 價差與說明
      const { optionDelta, optionSummary } = readSelectionsFor(item);

      const itemForCart = { ...item, price: (item.price||0) + optionDelta };
      addToCart({
        item: itemForCart,
        qty,
        remark,
        needStaple:false,
        _optionText: optionSummary ? `｜${optionSummary}` : ''
      });

      closeItemModal();
    };

    el('#itemModal').classList.remove('hidden');
  });
}
function closeItemModal(){
  el('#itemModal')?.classList.add('hidden');
  document.body.classList.remove('overflow-hidden');
}
function ensureItemModal(){
  if (el('#itemModal')) return;
  const wrap = document.createElement('div');
  wrap.id = 'itemModal';
  wrap.className = 'fixed inset-0 z-40 hidden scroll-y';
  wrap.innerHTML = `
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative z-10 min-h-full flex items-start justify-center py-6 px-3">
      <div class="w-full max-w-2xl card bg-white p-6 max-h-[85vh] scroll-y">
        <div class="flex items-start justify-between">
          <div class="min-w-0">
            <h3 id="pmTitle" class="text-xl font-semibold"></h3>
          </div>
          <button id="pmClose" class="btn px-3 py-2 border border-slate-300 hover:bg-slate-100">關閉</button>
        </div>

        <div id="pmStapleWrap" class="mt-4">
          <label class="text-sm text-slate-600">主食</label>
          <select id="pmStaple" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 bg-white text-slate-900"></select>
        </div>

        <!-- 動態選項容器 -->
        <div id="pmOptions" class="mt-4 space-y-4"></div>

        <div class="mt-2">
          <label class="text-sm text-slate-600">備註（選填）</label>
          <textarea id="pmRemark" rows="2"
            class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 bg-white text-slate-900"
            placeholder=""></textarea>
        </div>

        <div class="mt-5">
          <label class="text-sm text-slate-600">數量</label>
          <div class="mt-1 flex items-center gap-2">
            <button id="pmDec" class="btn px-3 py-2 border border-slate-300 hover:bg-slate-100">-</button>
            <input id="pmQty" type="number" min="1" value="1" class="w-20 text-center border border-slate-300 rounded-xl py-2 bg-white text-slate-900" />
            <button id="pmInc" class="btn px-3 py-2 border border-slate-300 hover:bg-slate-100">+</button>
          </div>
        </div>

        <div class="mt-6 flex items-center justify-between">
          <div class="text-lg">小計：<span id="pmSubtotal" class="font-semibold mono">$0</span></div>
          <button id="pmAdd" class="btn px-4 py-2 bg-slate-900 text-white hover:bg-slate-800">加入購物車</button>
        </div>
      </div>
    </div>
  `;
  document.body.appendChild(wrap);
  wrap.querySelector('#pmClose').addEventListener('click', closeItemModal);
}

/* === 一般類（漢堡/吐司/蛋餅/總匯/客製） === */
function buildOptionControls(catKey){
  const root = el('#pmOptions'); root.innerHTML = '';
  const itemId = currentItem?.id || '';  // ★ 新增：抓目前品項 id

  // ★ 若是焗烤吐司三款，直接不顯示任何選項
  if (['toast_bacon_bake','toast_tuna_bake','toast_ham_bake'].includes(itemId)) return;
  const rules = CATEGORY_OPTION_RULES[catKey] || [];
  rules.forEach(rule=>{
    if (rule.type === 'toggle'){
      const id = `opt_${rule.key}`;
      root.insertAdjacentHTML('beforeend', `
        <label class="flex items-center gap-3 border rounded-xl px-3 py-2">
          <input id="${id}" type="checkbox" data-opt-type="toggle" data-key="${rule.key}" data-price="${rule.price||0}">
          <span>${rule.label}${rule.price?`（+${rule.price}）`:''}</span>
        </label>
      `);
    } else if (rule.type === 'choice'){
      const id = `opt_${rule.key}`;
      const opts = (rule.options||[]).map(o=>`<option value="${o.value}" data-price="${o.price||0}">${o.label}${o.price?`（+${o.price}）`:''}</option>`).join('');
      root.insertAdjacentHTML('beforeend', `
        <div>
          <label class="text-sm text-slate-600">${rule.label}</label>
          <select id="${id}" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 bg-white text-slate-900"
                  data-opt-type="choice" data-key="${rule.key}">
            ${opts}
          </select>
        </div>
      `);
    }
  });
}
// 果醬吐司（基價 20）：香蒜 +5 其餘 +0
const JAM_FLAVORS = [
  { value:"草莓", add:0 }, { value:"奶酥", add:0 }, { value:"巧克力", add:0 },
  { value:"奶油", add:0 }, { value:"花生", add:0 }, { value:"香蒜", add:5 },
];

// 厚片吐司（基價 30）：香蒜 +5；可可/抹茶/牛奶 +10；其餘 +0
const THICK_FLAVORS = [
  { value:"草莓", add:0 }, { value:"奶酥", add:0 }, { value:"巧克力", add:0 },
  { value:"奶油", add:0 }, { value:"花生", add:0 }, { value:"香蒜", add:5 },
  { value:"可可", add:10 }, { value:"抹茶", add:10 }, { value:"牛奶", add:10 },
];
// 共用的系列口味彈窗
function buildToastSeriesControls(series){ // series: 'jam' | 'thick'
  const root = el('#pmOptions'); 
  root.innerHTML = '';
  const list = series === 'jam' ? JAM_FLAVORS : THICK_FLAVORS;

  // 口味選項
  const options = list.map(f=>`<option value="${f.value}" data-add="${f.add}">
    ${f.value}${f.add?`（+${f.add}）`:''}
  </option>`).join('');

  root.insertAdjacentHTML('beforeend', `
    <div>
      <label class="text-sm text-slate-600">口味</label>
      <select id="opt_toast_flavor"
              class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 bg-white text-slate-900">
        ${options}
      </select>
    </div>
  `);

  // ★ 如果是果醬系列，額外提供「換鬆餅 +15」
  if (series === 'jam') {
    root.insertAdjacentHTML('beforeend', `
      <label class="flex items-center gap-3 border rounded-xl px-3 py-2">
        <input id="opt_toast_waffle" type="checkbox" data-opt-type="toggle" data-key="waffle" data-price="15">
        <span>換鬆餅（+15）</span>
      </label>
    `);
  }
}


/* === 飲料：杯型/冰熱（依 DRINKS_META 決定可選與加價） === */
function buildDrinkControls(item, containerSel='#pmOptions'){
  const meta = DRINKS_META[item.id] || { baseSize:'M', sizes:['M','L','XL'], temps:['ice','hot'] };
  const root = el(containerSel); root.innerHTML = '';

  const sizeOpts = meta.sizes.map(sz=>{
    let extra = 0;
    if (meta.baseSize === 'M') extra = (sz==='L'?5:(sz==='XL'?10:0));
    if (meta.baseSize === 'L') extra = (sz==='XL'?10:0);
    if (meta.xlExtra && sz==='XL') extra = meta.xlExtra;
    const text = sz==='M'?'小':(sz==='L'?'中':'大');
    return `<option value="${sz}" data-extra="${extra}">${text}${extra?`（+${extra}）`:''}</option>`;
  }).join('');

  const tempOpts = meta.temps.map(t=>{
    const text = t==='ice'?'冰':'熱';
    return `<option value="${t}">${text}</option>`;
  }).join('');

  root.insertAdjacentHTML('beforeend', `
    <div class="grid gap-3 md:grid-cols-2">
      <div>
        <label class="text-sm text-slate-600">杯型</label>
        <select id="opt_drink_size" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 bg-white text-slate-900"
                data-kind="drink_size">
          ${sizeOpts}
        </select>
      </div>
      <div>
        <label class="text-sm text-slate-600">溫度</label>
        <select id="opt_drink_temp" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 bg-white text-slate-900"
                data-kind="drink_temp">
          ${tempOpts}
        </select>
      </div>
    </div>
  `);
}

/* === 研磨咖啡：固定 M/L 價（不套 +5/+10）=== */
const COFFEE_PRICE = {
  coffee_americano: { M:35, L:55 },
  coffee_latte:     { M:50, L:75 },
  coffee_special:   { M:40, L:60 },
  coffee_yuanyang:  { M:40, L:60 },
};
function buildCoffeeControls(item){
  const price = COFFEE_PRICE[item.id] || { M:item.price||0, L:(item.price||0)+10 };
  const root = el('#pmOptions'); root.innerHTML = '';
  root.insertAdjacentHTML('beforeend', `
    <div class="grid gap-3 md:grid-cols-2">
      <div>
        <label class="text-sm text-slate-600">杯型</label>
        <select id="opt_coffee_size" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 bg-white text-slate-900"
                data-kind="coffee_size">
          <option value="M" data-extra="0">中（$${price.M}）</option>
          <option value="L" data-extra="${price.L - price.M}">大（$${price.L}）</option>
        </select>
      </div>
      <div>
        <label class="text-sm text-slate-600">溫度</label>
        <select id="opt_coffee_temp" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 bg-white text-slate-900"
                data-kind="coffee_temp">
          <option value="ice">冰</option>
          <option value="hot">熱</option>
        </select>
      </div>
    </div>
  `);
}

/* === 套餐：上方確認套餐、下方選「套餐飲品」+ 杯型/冰熱 + 加價 === */
function buildSetmealControls(item){
  const root = el('#pmOptions'); 
  root.innerHTML = '';

  // 1) 套餐確認
  root.insertAdjacentHTML('beforeend', `
    <div class="border rounded-xl">
      <div class="px-3 py-2 bg-slate-100 text-slate-800 font-medium rounded-t-xl">套餐</div>
      <div class="px-3 py-2 flex items-center gap-3">
        <input type="radio" checked class="accent-slate-900">
        <span>${item.name}</span>
      </div>
    </div>
  `);

  // 2) ★ 套餐附加選項（醬汁/口味）—先放在前面
  const extra = SETMEAL_EXTRA_RULES[item.id];
  if (extra) {
    const optHtml = extra.options.map(v => `<option value="${v}">${v}</option>`).join('');
    root.insertAdjacentHTML('beforeend', `
      <div id="blk_set_extra" class="border rounded-xl mt-4">
        <div class="px-3 py-2 bg-slate-100 text-slate-800 font-medium rounded-t-xl">${extra.label}</div>
        <div class="p-3">
          <select id="opt_set_extra" class="w-full rounded-xl border border-slate-300 px-3 py-2 bg-white text-slate-900"
                  data-extra-key="${extra.key}" data-extra-label="${extra.label}">
            ${optHtml}
          </select>
        </div>
      </div>
    `);
  }

  // 3) 套餐飲品（在「口味/醬汁」之後）
  const drinkRows = SETMEAL_DRINKS.map(d=>{
    const addTxt = d.add ? `+${d.add}` : '';
    return `
      <label class="flex items-center justify-between gap-3 px-3 py-2 border-b last:border-0">
        <span class="flex items-center gap-3">
          <input type="radio" name="opt_set_drink" value="${d.id}" data-add="${d.add||0}">
          <span>${d.label}${addTxt ? `（${addTxt}）` : ''}</span>
        </span>
      </label>`;
  }).join('');

  root.insertAdjacentHTML('beforeend', `
    <div id="blk_set_drinks" class="border rounded-xl mt-4">
      <div class="px-3 py-2 bg-slate-100 text-slate-800 font-medium rounded-t-xl">套餐飲品</div>
      <div id="set_drink_list" class="divide-y">${drinkRows}</div>
      <div id="set_drink_opts" class="p-3 hidden"></div>
    </div>
  `);

  // 4) 行為：選到飲品才顯示杯型/冰熱（並保持「口味/醬汁」在前方）
  const list = root.querySelector('#set_drink_list');
  const opts = root.querySelector('#set_drink_opts');
  list.addEventListener('change', ()=>{
    const id = root.querySelector('input[name="opt_set_drink"]:checked')?.value;
    if (!id) { opts.classList.add('hidden'); opts.innerHTML=''; return; }
    const tmpItem = { id, _catKey:'drinks' };
    const metaExtra = SETMEAL_DRINKS.find(x=>x.id===id)?.meta;
    if (metaExtra) DRINKS_META[id] = metaExtra;
    buildDrinkControls(tmpItem, '#set_drink_opts');
    opts.classList.remove('hidden');
    document.getElementById('pmOptions')?.dispatchEvent(new Event('change'));

    // 保序：確保「口味/醬汁」在「套餐飲品」之前
    const extraBlk = root.querySelector('#blk_set_extra');
    const drinkBlk = root.querySelector('#blk_set_drinks');
    if (extraBlk && drinkBlk && extraBlk.nextElementSibling !== drinkBlk) {
      root.insertBefore(extraBlk, drinkBlk);
    }
  });
}



/* === 讀取各類型的選擇 & 計價 === */
function readSelectionsFor(item){
  // 套餐
  if (item._catKey === 'setmeal'){
    const chosen = el('input[name="opt_set_drink"]:checked');
    let parts = [];
    let delta = 0;
  
    // 飲品 + 杯型/冰熱
    if (chosen){
      const drinkId = chosen.value;
      const add = Number(chosen.dataset.add||0);
      delta += add;
      const label = SETMEAL_DRINKS.find(d=>d.id===drinkId)?.label || '';
  
      const sizeSel = el('#opt_drink_size');
      const tempSel = el('#opt_drink_temp');
      let szTxt='', tempTxt='';
      if (sizeSel){
        const opt = sizeSel.selectedOptions[0];
        const szAdd = Number(opt.dataset.extra||0);
        delta += szAdd;
        szTxt = opt.textContent.replace(/（\+\d+）/,'');
      }
      if (tempSel) tempTxt = (tempSel.value==='ice'?'冰':'熱');
  
      parts.push(`套餐飲品：${label}${szTxt?`｜${szTxt}`:''}${tempTxt?`｜${tempTxt}`:''}`);
    }
  
    // ★ 套餐附加選項（醬汁/口味；不加價，只記錄）
    const extraSel = el('#opt_set_extra');
    if (extraSel){
      const extraLabel = extraSel.dataset.extraLabel || '選項';
      const extraValue = extraSel.value || '';
      if (extraValue) parts.push(`${extraLabel}：${extraValue}`);
    }
  
    return { optionDelta: delta, optionSummary: parts.join('｜') };
  }


  // 飲料
  if (item._catKey === 'drinks'){
    const sizeSel = el('#opt_drink_size');
    const tempSel = el('#opt_drink_temp');
    let delta = 0, parts = [];
    if (sizeSel){
      const so = sizeSel.selectedOptions[0];
      delta += Number(so.dataset.extra||0);
      parts.push('尺寸：' + so.textContent.replace(/（\+\d+）/,''));
    }
    if (tempSel){
      parts.push('溫度：' + (tempSel.value==='ice'?'冰':'熱'));
    }
    return { optionDelta: delta, optionSummary: parts.join('｜') };
  }

  // 研磨咖啡
  if (item._catKey === 'coffee'){
    const sizeSel = el('#opt_coffee_size');
    const tempSel = el('#opt_coffee_temp');
    let delta = 0, parts = [];
    if (sizeSel){
      const so = sizeSel.selectedOptions[0];
      delta += Number(so.dataset.extra||0);
      parts.push('尺寸：' + (sizeSel.value==='M'?'中':'大'));
    }
    if (tempSel){
      parts.push('溫度：' + (tempSel.value==='ice'?'冰':'熱'));
    }
    return { optionDelta: delta, optionSummary: parts.join('｜') };
  }
  // 系列吐司（果醬/厚片）：依口味加價
  if (item._catKey === 'toast' && (item.tag === 'jam_series' || item.tag === 'thick_series')){
    const sel = el('#opt_toast_flavor');
    let delta = 0, parts = [];
    if (sel){
      const opt = sel.selectedOptions[0];
      delta += Number(opt.dataset.add || 0);
      parts.push('口味：' + opt.value);
    }
    // ★ 讀取「換鬆餅」選項
    const waffle = el('#opt_toast_waffle');
    if (waffle?.checked){
      delta += Number(waffle.dataset.price || 0);
      parts.push('換鬆餅');
    }
    return { optionDelta: delta, optionSummary: parts.join('｜') };
  }


  // 一般類（漢堡/吐司/蛋餅/總匯/客製）
  const rules = CATEGORY_OPTION_RULES[item._catKey] || [];
  let delta = 0;
  const parts = [];
  rules.forEach(rule=>{
    if (rule.type === 'toggle'){
      const input = el(`#opt_${rule.key}`);
      if (input?.checked){
        const p = Number(input.dataset.price||0);
        delta += p;
        parts.push(rule.label);
      }
    } else if (rule.type === 'choice'){
      const sel = el(`#opt_${rule.key}`);
      const opt = sel?.selectedOptions?.[0];
      if (opt){
        const label = rule.label + '：' + opt.textContent.replace(/（\+\d+）$/, '');
        const p = Number(opt.dataset.price||0);
        delta += p;
        parts.push(label);
      }
    }
  });
  return { optionDelta: delta, optionSummary: parts.join('｜') };
}
function calcUnitPrice(item){
  const { optionDelta } = readSelectionsFor(item);
  return (item.price || 0) + optionDelta;
}

/* === Cart === */
function addToCart(bundle){
  state.cart.push({ type:'meal', ...bundle });
  renderCart();
}
function removeCartEntry(index){ state.cart.splice(index,1); renderCart(); }
function cartTotal(){
  return state.cart.reduce((sum,e)=>{
    if(e.type==='meal'){
      return sum + (e.item.price||0)*e.qty;
    }
    return sum;
  }, 0);
}
function renderCart(){
  const root=el('#cartItems'); root.innerHTML='';
  if(state.cart.length===0){ root.innerHTML='<div class="text-slate-500">購物車目前沒有商品。</div>'; }
  state.cart.forEach((e, idx)=>{
    const linePrice = (e.item.price||0)*e.qty;
    const optPart    = e._optionText ? ` ${e._optionText}` : '';
    const div=document.createElement('div');
    div.className='card bg-white p-4';
    div.innerHTML=`
      <div class="flex items-start justify-between gap-3">
        <div class="min-w-0">
          <div class="font-medium">${e.item.name}${optPart}</div>
          <div class="text-sm text-slate-700 mt-1">備註：${e.remark ? e.remark : '(無)'}</div>
          <div class="text-sm text-slate-600 mt-1">
            數量 ×
            <input type="number" min="1" value="${e.qty}" class="lineQty w-16 text-center border border-slate-300 rounded-lg py-1 mx-1 bg-white text-slate-900">
          </div>
        </div>
        <div class="shrink-0 text-right">
          <div class="font-semibold mono">${money(linePrice)}</div>
          <button class="remove btn mt-2 px-3 py-2 border border-slate-300 hover:bg-slate-100">移除</button>
        </div>
      </div>`;
    div.querySelector('.lineQty').addEventListener('input', ev=>{
      let v=parseInt(ev.target.value)||1; if(v<1)v=1; e.qty=v; renderCart();
    });
    div.querySelector('.remove').addEventListener('click', ()=> removeCartEntry(idx));
    root.appendChild(div);
  });
  el('#cartTotal').textContent=money(cartTotal());
}

/* === 外帶：時段產生（05:30-13:00，每15分） === */
function generateSlots(dateObj = new Date()){
  const y = dateObj.getFullYear();
  const m = dateObj.getMonth();
  const d = dateObj.getDate();
  const slots = [];
  const start = new Date(y, m, d, BUSINESS.startHour, 30, 0); // 05:30
  const end   = new Date(y, m, d, BUSINESS.endHour, 0, 0);    // 13:00
  for (let t = new Date(start); t <= end; t = new Date(t.getTime() + BUSINESS.intervalMin*60000)) {
    slots.push(new Date(t));
  }
  return slots;
}
function fillPickupSelect(){
  const sel = el('#pickupSelect');
  const offMsg = el('#offHourMsg');
  sel.innerHTML = '';
  state.slots.forEach(dt=>{
    const hh = pad2(dt.getHours());
    const mm = pad2(dt.getMinutes());
    const o = document.createElement('option');
    o.value = dt.toISOString();
    o.textContent = `${hh}:${mm}`;
    sel.appendChild(o);
  });
  const auto = document.createElement('option');
  auto.value = '';
  auto.textContent = '（不指定，系統自動安排最早時段）';
  sel.insertBefore(auto, sel.firstChild);
  sel.value = '';

  const now = new Date();
  const start = new Date(now.getFullYear(), now.getMonth(), now.getDate(), BUSINESS.startHour, 30, 0);
  const end   = new Date(now.getFullYear(), now.getMonth(), now.getDate(), BUSINESS.endHour, 0, 0);
  const offHour = now < start || now > end;
  offMsg.classList.toggle('hidden-imp', !offHour);
  if (offHour) offMsg.textContent = '目前非營業時段（05:30–13:00），可先下單選擇時段。';
}
function roundUpTo15min(date){
  const ms = BUSINESS.intervalMin*60000;
  return new Date(Math.ceil(date.getTime()/ms)*ms);
}
function chooseEarliestSlot(now = new Date()){
  const earliest = roundUpTo15min(new Date(now.getTime() + BUSINESS.intervalMin*60000));
  for (const s of state.slots){
    if (s.getTime() >= earliest.getTime()) return s;
  }
  return state.slots[state.slots.length - 1] || null;
}

/* === Sold-out 狀態 === */
let SOLDOUT_CACHE = { ts: 0, byName: new Map() };
const SOLDOUT_TTL_MS = 30 * 1000;

async function fetchMenuStatus(force=false){
  const now = Date.now();
  if (!ENDPOINT) { SOLDOUT_CACHE = { ts: now, byName: new Map() }; return SOLDOUT_CACHE; }
  if (!force && (now - SOLDOUT_CACHE.ts) < SOLDOUT_TTL_MS) return SOLDOUT_CACHE;
  try{
    const url = `${ENDPOINT}?action=menu&_=${now}&apiKey=${API_KEY}`;
    const r = await fetch(url);
    const d = await r.json();
    const byName = new Map();
    for (const it of (d.items||[])) if (it.name) byName.set(String(it.name), !!it.soldOut);
    SOLDOUT_CACHE = { ts: now, byName };
  }catch{
    SOLDOUT_CACHE = { ts: now, byName: new Map() };
  }
  return SOLDOUT_CACHE;
}
async function isSoldOut(name){
  const { byName } = await fetchMenuStatus(false);
  return !!byName.get(name);
}
async function checkSoldOutByName(name){ try{ return await isSoldOut(name);}catch{ return false; } }

async function enforceSoldOutOnMenu(force = false) {
  try {
    const { byName } = await fetchMenuStatus(force);
    document.querySelectorAll('.choose-btn').forEach(btn => {
      const name = btn.dataset.name || '';
      const sold = !!byName.get(name);
      const wrap = btn.parentElement;
      if (!wrap) return;
      let soldPill = wrap.querySelector('.sold-pill');
      if (sold) {
        btn.classList.add('hidden');
        if (!soldPill) {
          soldPill = document.createElement('span');
          soldPill.className = [
            'sold-pill','inline-flex items-center justify-center',
            'px-4 py-2','rounded-xl','border border-slate-300',
            'bg-slate-100 text-slate-500','cursor-not-allowed select-none'
          ].join(' ');
          soldPill.textContent = '售完';
          wrap.insertBefore(soldPill, btn);
        }
      } else {
        btn.classList.remove('hidden');
        if (soldPill) soldPill.remove();
      }
    });
  } catch (err) { console.warn('套用售完狀態失敗：', err); }
}

/* === Apps Script API：reserve + confirm + sync === */
async function apiReserve(orderId, pickupAtHintISO, diningType, tableNo){
  const body = { apiKey: API_KEY, action: 'reserve', orderId };
  if (pickupAtHintISO) body.pickupAtHint = pickupAtHintISO;
  if (diningType) body.diningType = diningType;
  if (tableNo) body.tableNo = tableNo;
  const r = await fetch(ENDPOINT, { method: 'POST', headers:{'Content-Type':'text/plain'}, body: JSON.stringify(body) });
  const t = await r.text();
  let d; try { d = JSON.parse(t); } catch { throw new Error('送單失敗，請稍後再試'); }
  return d;
}
async function apiConfirm(order){
  const r = await fetch(ENDPOINT, {
    method: 'POST',
    headers:{'Content-Type':'text/plain'},
    body: JSON.stringify({ apiKey: API_KEY, action: 'confirm', order })
  });
  const t = await r.text();
  let d; try { d = JSON.parse(t); } catch { throw new Error('送單失敗，請稍後再試'); }
  return d;
}
async function apiSync(){
  try { await fetch(ENDPOINT, { method: 'POST', headers:{'Content-Type':'text/plain'}, body: JSON.stringify({ apiKey: API_KEY, action: 'sync' }) }); }
  catch {}
}

/* === 小工具：顯示 HH:mm === */
function hhmmFromISO(iso){
  if (!iso) return '';
  const d = new Date(iso);
  if (isNaN(d.getTime())) return iso;
  return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
}

/* === Submit === */
async function onSubmitOrder(e) {
  e.preventDefault();
  const btn = el('#submitBtn');
  const setBusy = b => { btn.disabled = b; btn.textContent = b ? '送出中…' : '送出訂單'; };
  const showErr = m => el('#formError').textContent = m;
  setBusy(true); showErr('');

  try {
    if (state.cart.length === 0) { showErr('購物車尚無商品。'); return; }
    const name = el('#customerName').value.trim();
    const phone = el('#customerPhone').value.trim();
    if (!name || !phone) { showErr('請完整填寫姓名與電話。'); return; }

    const diningType = document.querySelector('input[name="diningType"]:checked')?.value || 'takeout';
    const tableNo = diningType === 'dinein' ? el('#tableNo').value.trim() : '';
    if (diningType === 'dinein' && !tableNo) { showErr('請填寫桌號。'); return; }

    const userChosenISO = (diningType === 'takeout' && el('#pickupSelect').value) ? el('#pickupSelect').value : '';
    const autoSlot = (diningType === 'takeout' && !userChosenISO) ? chooseEarliestSlot() : null;
    const pickupAtHintISO = (userChosenISO || (autoSlot ? autoSlot.toISOString() : ''));

    const createdAt = new Date();
    const selectedPickupTime = pickupAtHintISO ? new Date(pickupAtHintISO) : createdAt;
    if (selectedPickupTime < createdAt) { showErr('取餐時間不能早於訂單創建時間。'); return; }

    const items = state.cart.map(e => {
      const optsPart   = e._optionText ? `｜${e._optionText}` : '';
      const nameWith = `${e.item.name}${optsPart}`;
      return { id: e.item.id, name: nameWith, price: e.item.price, qty: e.qty };
    });
    const subtotal = items.reduce((s, it) => s + it.price * it.qty, 0);

    const orderId = (crypto?.randomUUID?.() || (Date.now()+'-'+Math.random().toString(16).slice(2)));
    const order = {
      orderId,
      customer: { name, phone },
      items, subtotal, total: subtotal,
      createdAt: createdAt.toISOString(),
      source: 'zhaojin-web',
      diningType,
      tableNo: tableNo || null,
      desiredPickupTime: (diningType === 'takeout' ? (pickupAtHintISO || null) : null)
    };

    const res = await apiReserve(orderId, pickupAtHintISO, diningType, tableNo);
    if (!res.ok) { showErr(mapApiError(res.error, res.message)); return; }

    el('#pickupNoText').textContent = String(res.pickupNo ?? '');
    if (diningType === 'takeout') {
      el('#successTakeoutTime').classList.remove('hidden');
      el('#successTable').classList.add('hidden');
      el('#pickupTimeText').textContent = hhmmFromISO(res.pickupTime ?? pickupAtHintISO ?? '');
    } else {
      el('#successTakeoutTime').classList.add('hidden');
      el('#successTable').classList.remove('hidden');
      el('#tableNoText').textContent = tableNo || '';
    }
    el('#successModal').classList.remove('hidden');

    (async () => { try { const c = await apiConfirm(order); if (c && c.ok) { apiSync(); } } catch (_) {} })();

    state.cart = []; renderCart();

  } catch (err) {
    el('#formError').textContent = '送單失敗：' + (err?.message || '請稍後再試');
  } finally { setBusy(false); }
}

/* === 用餐方式切換（顯示外帶時段 / 內用桌號） === */
function onDiningTypeChange(){
  const type = document.querySelector('input[name="diningType"]:checked')?.value || 'takeout';
  if (type==='takeout'){
    el('#takeoutBlock').classList.remove('hidden');
    el('#dineinBlock').classList.add('hidden');
  } else {
    el('#takeoutBlock').classList.add('hidden');
    el('#dineinBlock').classList.remove('hidden');
  }
}

/* === Init === */
function initSlots(){
  state.slots = generateSlots(new Date());
  fillPickupSelect();
}

document.addEventListener('DOMContentLoaded',()=>{
  el('#year').textContent=new Date().getFullYear();
  ensureItemModal();

  fetchMenuStatus(true).catch(()=>{});

  renderCategory(MENU.setmeal, '#setmealList', 'setmeal');
  renderCategory(MENU.burger,  '#burgerList',  'burger');
  renderCategory(MENU.toast,   '#toastList',   'toast');
  renderCategory(MENU.omelet,  '#omeletList',  'omelet');
  renderCategory(MENU.club,    '#clubList',    'club');
  renderCategory(MENU.special, '#specialList', 'special');
  renderCategory(MENU.custom,  '#customList',  'custom');
  renderCategory(MENU.snacks,  '#snacksList',  'snacks');
  renderCategory(MENU.hotpot,  '#hotpotList',  'hotpot');
  renderCategory(MENU.coffee,  '#coffeeList',  'coffee');
  renderCategory(MENU.drinks,  '#drinksList',  'drinks');

  (async ()=>{ await enforceSoldOutOnMenu(true); setInterval(()=> enforceSoldOutOnMenu(false), SOLDOUT_TTL_MS); })();

  ensureCategoryAnchors();
  paintCategoryButtons();
  bindCategoryClicks();
  observeActiveCategory();

  renderCart();
  el('#clearCart').addEventListener('click',()=>{state.cart=[];renderCart();});
  el('#checkoutForm').addEventListener('submit',onSubmitOrder);
  el('#closeSuccess').addEventListener('click',()=>el('#successModal').classList.add('hidden'));

  initSlots();
  document.querySelectorAll('input[name="diningType"]').forEach(r=>{ r.addEventListener('change', onDiningTypeChange); });
  onDiningTypeChange();
  setInterval(initSlots, 60*1000);
});

/* ===== 分類設定（加入 snacks、coffee） ===== */
const CATEGORY_SECTIONS = [
  { key:'setmeal', label:'套餐',       listSel:'#setmealList', color:'#242d47' },
  { key:'burger',  label:'漢堡',       listSel:'#burgerList',  color:'#c9141a' },
  { key:'toast',   label:'烤土司',     listSel:'#toastList',   color:'#242d47' },
  { key:'omelet',  label:'蛋餅',       listSel:'#omeletList',  color:'#c9141a' },
  { key:'club',    label:'總匯',       listSel:'#clubList',    color:'#242d47' },
  { key:'special', label:'店長推薦',   listSel:'#specialList', color:'#c9141a' },
  { key:'custom',  label:'帕瑪森/捲餅/香頌/燒餅', listSel:'#customList',  color:'#242d47' },
  { key:'snacks',  label:'美味小點',   listSel:'#snacksList',  color:'#c9141a' },
  { key:'hotpot',  label:'鍋燒系列',   listSel:'#hotpotList',  color:'#242d47' },
  { key:'drinks',  label:'飲料',       listSel:'#drinksList',  color:'#c9141a' },
  { key:'coffee',  label:'研磨咖啡',   listSel:'#coffeeList',  color:'#242d47' },
  
];

function ensureCategoryAnchors(){
  CATEGORY_SECTIONS.forEach(({ key, listSel })=>{
    const list = document.querySelector(listSel);
    if (!list) return;
    const headerDiv = list.previousElementSibling;
    const h2 = headerDiv?.querySelector('h2');
    const anchorEl = h2 || list.closest('.cat-wrap') || list;
    if (!anchorEl.id) anchorEl.id = `sec-${key}`;
    anchorEl.classList.add('section-anchor');
  });
}
function getScrollOffsetPx(){
  const header = document.querySelector('header');
  const bar    = document.querySelector('#categoryBar');
  return (header?.offsetHeight || 0) + (bar?.offsetHeight || 0) + 8;
}
function scrollToCategory(key){
  const sec = document.getElementById(`sec-${key}`);
  if (!sec) return;
  const top = sec.getBoundingClientRect().top + window.pageYOffset - getScrollOffsetPx();
  window.scrollTo({ top, behavior:'smooth' });
}
function paintCategoryButtons(){
  const btns = document.querySelectorAll('#categoryBar .catbtn');
  btns.forEach(btn=>{
    const conf = CATEGORY_SECTIONS.find(x=>x.key === btn.dataset.cat);
    if (conf) btn.style.color = conf.color;
  });
}
function bindCategoryClicks(){
  document.querySelectorAll('#categoryBar .catbtn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const key = btn.dataset.cat;
      scrollToCategory(key);
      document.querySelectorAll('#categoryBar .catbtn').forEach(b=>b.classList.remove('is-active'));
      btn.classList.add('is-active');
    });
  });
}
function observeActiveCategory(){
  const buttons = Array.from(document.querySelectorAll('#categoryBar .catbtn'));
  const mapBtn  = Object.fromEntries(buttons.map(b => [b.dataset.cat, b]));
  const io = new IntersectionObserver(entries=>{
    const visible = entries.filter(e => e.isIntersecting).sort((a,b)=> a.boundingClientRect.top - b.boundingClientRect.top);
    if (!visible.length) return;
    const key = (visible[0].target.id || '').replace(/^sec-/,'');
    if (mapBtn[key]) {
      buttons.forEach(b=>b.classList.remove('is-active'));
      mapBtn[key].classList.add('is-active');
    }
  }, { root:null, rootMargin:`-${getScrollOffsetPx()+10}px 0px -60% 0px`, threshold:0 });
  CATEGORY_SECTIONS.forEach(({ key })=>{
    const anchor = document.getElementById(`sec-${key}`);
    if (anchor) io.observe(anchor);
  });
}
function stickCategoryBar(){
  const header = document.querySelector('header');
  const bar = document.getElementById('categoryBar');
  if (!header || !bar) return;
  bar.style.top = (header.offsetHeight || 0) + 'px';
}
window.addEventListener('load', stickCategoryBar);
window.addEventListener('resize', stickCategoryBar);
{
  const header = document.querySelector('header');
  if (header && 'ResizeObserver' in window) {
    const ro = new ResizeObserver(()=> stickCategoryBar());
    ro.observe(header);
  }
}
</script>

</body>
</html>
